<!DOCTYPE html>
<html lang="en"  style="width: 810px">
<head>
	<meta charset="UTF-8">
	<title>微信公众号排名</title>
  <script src="jquery.min.js"></script>
  <style>
    .axis path,
    .axis line {
      fill: none;
      stroke: #000;
      shape-rendering: crispEdges;
      stroke-width: 2;
    }
    #main, #main2 {
      position: relative;
    }
  </style>
</head>
<body style="width: 810px;text-align: center;">
	 <div class='qs_more' style="display:auto;">
        <div class="chart">
            <div id="main"></div>
            <form id="changeInput">
                <label><input type="radio" name="mode" value="grouped"> Grouped</label>
                <label><input type="radio" name="mode" value="stacked" checked> Stacked</label>
            </form>
            <div id="main2"></div>
        </div>
    </div>
<script src="d3.v3.min.js"></script>
<script>
var topicArray = [1,2,3,4];
var dateTime = 30;
window.addEventListener('message', function(e){
            console.log('foo say: ' + e.data.topicArray + '  ' + e.data.dateTime);
            topicArray = e.data.topicArray.split(',');
            dateTime = e.data.dateTime;
            e.source.postMessage('get', '*');

            transition();
        }, false)

var datearray = [];
var colorrange = [];


var format = d3.time.format("%m/%d/%y");

var margin = {top: 20, right: 40, bottom: 80, left: 30};
var width = 640 - margin.left - margin.right;
var height = 450 - margin.top - margin.bottom;

var tooltip = d3.select("#main")
    .append("div")
    .attr("class", "remove")
    .style("position", "absolute")
    .style("z-index", "20")
    .style("visibility", "hidden")
    .style("top", "30px")
    .style("left", "120px");

var x = d3.time.scale()
    .range([0, width]);

var y = d3.scale.linear()
    .range([height, 0]);

var xAxis = d3.svg.axis()
    .scale(x)
    .orient("bottom")
    .ticks(d3.time.weeks)
    .tickFormat(d3.time.format("%b%e"));

var xAxis_se = d3.svg.axis()
    .scale(x)
    .orient("bottom")
    .ticks(d3.time.days)
    .tickFormat(d3.time.format("%b%e"));

var xAxis_th = d3.svg.axis()
    .scale(x)
    .orient("bottom")
    .ticks(d3.time.weeks)
    .tickFormat(d3.time.format("%b%e"));

var yAxis = d3.svg.axis()
    .scale(y);

var stack = d3.layout.stack()
    .offset("silhouette")
    .values(function(d) { return d.values; })
    .x(function(d) { return d.date; })
    .y(function(d) { return d.value; });

var nest = d3.nest()
    .key(function(d) { return d.key; });

var area = d3.svg.area()
    .interpolate("cardinal")
    .x(function(d) { return x(d.date); })
    .y0(function(d) { return y(d.y0); })
    .y1(function(d) { return y(d.y0 + d.y); });

var svg = d3.select("#main").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

var _legendbottom = -30;
function renderLegend(color, data, s){  

        var len = data.length;
        color = color.slice(0, len);

        var legend = s.selectAll(".legend")  
            // .data(_colors.domain())  
            .data(color)
            .enter()  
            .append("g")  
            .attr("class", "legend")
            .attr("transform", function(d, i) {  
                var legendX = i * 120 + margin.left;   //set position for each legend element  
                var legendY = height - _legendbottom;  
                return "translate(" + legendX + ", " + legendY + ")";  
            });  

          
        legend.append("rect")  
            .attr("x", 0)  
            .attr("y", 1)  
            .attr("width", 16)  
            .attr("height", 8)  
            .style("fill", function(d){
                return d;
            });  
          
        legend.append("text")
            .data(data)
            .attr("x", 20)  
            .attr("y", 9)  
            .classed("legendtext", true)  
            .text(function(d) {  
                return d.key;  
            });  
    }


function chart(csvpath, color) {

  if (color == "blue") {
          colorrange = ["#045A8D", "#2B8CBE", "#74A9CF", "#A6BDDB", "#D0D1E6", "#F1EEF6"];
      }
      else if (color == "pink") {
        colorrange = ["#980043", "#DD1C77", "#DF65B0", "#C994C7", "#D4B9DA", "#F1EEF6"];
      }
      else if (color == "orange") {
        // colorrange = ["#B30000", "#E34A33", "#FC8D59", "#FDBB84", "#FDD49E", "#FEF0D9"];
        colorrange = ["#B30000", "#E34A33", "#FC8D59", "#FDBB84"];
      }
  strokecolor = colorrange[0];
       var colorR = [[d3.rgb(179,0,0), d3.rgb(100,0,0)],[d3.rgb(227, 74, 51), d3.rgb(150, 74, 51)],[d3.rgb(252, 141, 89), d3.rgb(150, 141, 89)],[d3.rgb(253, 187, 132), d3.rgb(130, 187, 132)]];

  z = d3.scale.ordinal()
      .range(colorrange);

  var graph = d3.json(csvpath, function(data){
    console.log(data);
        var dayV = dateTime;

        var a = [];

        for(var i = 0; i < topicArray.length; i++){
                a[topicArray[i]-1] = topicArray[i]-1;
        }

        var ds = [];
         data.forEach(function(d, i){
            if((a[i]) == i){
                ds = ds.concat(d.slice(d.length-dayV, d.length));
            }
        });
         data = ds;
         if(!data.length){
            return true;
         }

        data.forEach(function(d){
            d.dateStr = d.date;
            d.date = format.parse(d.date);
            // d.value = +d.value;
            d.value = parseFloat(d.value.toFixed(2));
        });



       var layers = stack(nest.entries(data));


       var colorArr = [];
       layers.forEach(function(d, i){
          var defs = svg.append("defs");
          var ad = colorR[i][0]
          var bd = colorR[i][1]
          var linearGradient = defs.append("linearGradient")
                              .attr("id","linearColor"+i)  
                              .attr("x1","0%")  
                              .attr("y1","0%")  
                              .attr("x2","100%")  
                              .attr("y2","0%");  
        
          var start_color = ad.toString();
          var end_color = ad.toString();
          var item_color = ad.toString();

          if(d.values[0].zf==-1){
              start_color = bd.toString();
          }
          if(d.values[d.values.length-1].zf==-1){
              end_color = bd.toString();
          }

          var start = linearGradient.append("stop")  
                          .attr("offset","0%")  
                          .style("stop-opacity", "1")
                          .style("stop-color",start_color);

          var offset = 100/d.values.length;
          var sum = 0;

          d.values.forEach(function(val,index){

              sum += offset

              if(val.zf==-1){
                  item_color = bd.toString();
              }
              else{
                  item_color = ad.toString();
              }
              var item = linearGradient.append("stop")  
                              .attr("offset", sum+"%")  
                              .style("stop-opacity", "1")
                              .style("stop-color",item_color);          
          });

          var stop = linearGradient.append("stop")  
                          .attr("offset","100%") 
                          .style("stop-opacity", "1") 
                          .style("stop-color",end_color);
          colorArr.push(linearGradient);
       });

        x.domain(d3.extent(data, function(d) { return d.date; }));
        y.domain([0, d3.max(data, function(d) { return d.y0 + d.y; })]);

        svg.selectAll(".layer")
            .data(layers)
          .enter().append("path")
            .attr("class", "layer")
            .attr("d", function(d) { return area(d.values); })
            .style("fill",function(d,i){
                  return "url(#" + colorArr[i].attr("id") + ")";
                });


        svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(xAxis);


        svg.append("g")
            .attr("class", "y axis")
            .call(yAxis.orient("left"));

        svg.selectAll(".layer")
          .attr("opacity", 1)
          .on("mouseover", function(d, i) {
            svg.selectAll(".layer").transition()
            .duration(250)
            .attr("opacity", function(d, j) {
              return j != i ? 0.6 : 1;
          })})

          .on("mousemove", function(d, i) {
            mousex = d3.mouse(this);
            mousex = mousex[0];
            var invertedx = x.invert(mousex);
            invertedx = invertedx.getMonth() + invertedx.getDate();
            var selected = (d.values);
            for (var k = 0; k < selected.length; k++) {
              datearray[k] = selected[k].date
              datearray[k] = datearray[k].getMonth() + datearray[k].getDate();
            }

            mousedate = datearray.indexOf(invertedx);
            pro = d.values[mousedate].value;

            d3.select(this)
            .classed("hover", true)
            .attr("stroke", strokecolor)
            .attr("stroke-width", "0.5px"), 
            tooltip.html( "<p>" + d.key + "<br>" + pro + "<br>" + d.values[mousedate].dateStr + "</p>" ).style("visibility", "visible");
            
          })
          .on("mouseout", function(d, i) {
           svg.selectAll(".layer")
            .transition()
            .duration(250)
            .attr("opacity", "1");
            d3.select(this)
            .classed("hover", false)
            .attr("stroke-width", "0px"), tooltip.html( "<p>" + d.key + "<br>" + pro + "<br>" + d.values[mousedate].dateStr +  "</p>" ).style("visibility", "hidden");
        })
          
        var vertical = d3.select("#main")
              .append("div")
              .attr("class", "remove")
              .style("position", "absolute")
              .style("z-index", "19")
              .style("width", "1px")
              .style("height", "380px")
              .style("top", "10px")
              .style("bottom", "30px")
              .style("left", "-5px")
              .style("background", "#fff");

        d3.select("#main")
            .on("mousemove", function(){  
               mousex = d3.mouse(this);
               mousex = mousex[0] + 5;
               vertical.style("left", mousex + "px" )})
            .on("mouseover", function(){  
               mousex = d3.mouse(this);
               mousex = mousex[0] + 5;
               vertical.style("left", mousex + "px")});

            renderLegend(colorrange, layers, svg);
  });
}
function transition() {
    d3.selectAll('#main2 g *').remove();
    d3.selectAll('#main g *').remove();

    d3.selectAll('#main .remove').remove();
    d3.selectAll('#main2 .remove').remove();
    if(dateTime == 30){
      xAxis = xAxis_th;
    }else {
      xAxis = xAxis_se;
    }
    chart('data/d4.json', "orange");
    zhexian('data/d4.json', "orange");
}

chart('d4.json', "orange");
zhexian('d4.json', "orange");




var line = d3.svg.line() // <-D
        .x(function(d){return x(d.date);})
        .y(function(d){return y(d.y);})
        
 var svg1 = d3.select("#main2").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

function zhexian(csvpath, color) {

    var stack = d3.layout.stack()
    .offset("zero")
    .values(function(d) { return d.values; })
    .x(function(d) { return d.date; })
    .y(function(d) { return d.value; });

    if (color == "blue") {
        colorrange = ["#045A8D", "#2B8CBE", "#74A9CF", "#A6BDDB", "#D0D1E6", "#F1EEF6"];
    }
    else if (color == "pink") {
      colorrange = ["#980043", "#DD1C77", "#DF65B0", "#C994C7", "#D4B9DA", "#F1EEF6"];
    }
    else if (color == "orange") {
      colorrange = ["#B30000", "#E34A33", "#FC8D59", "#FDBB84"];
    }
  strokecolor = colorrange[0];


  var graph = d3.json(csvpath, function(data){

        var dayV = dateTime

        var a = [];

        for(var i = 0; i < topicArray.length; i++){
            a[topicArray[i]-1] = topicArray[i]-1;
        }


        var ds = [];
         data.forEach(function(d, i){
            if((a[i]) == i){
                ds = ds.concat(d.slice(d.length-dayV, d.length));
            }
        });
         data = ds;
         if(!data.length){
            return true;
         }
        data.forEach(function(d){
            d.dateStr = d.date;
            d.date = format.parse(d.date);
            // d.value = +d.value;
            d.value = parseFloat(d.value.toFixed(2));
        });

 
 
       var layers = stack(nest.entries(data)),

          yGroupMax = d3.max(layers, function(layer) { return d3.max(layer.values, function(d) { return d.y; }); }),
          yStackMax = d3.max(layers, function(layer) { return d3.max(layer.values, function(d) { return d.y0 + d.y; }); });

        var x = d3.scale.ordinal()
          .domain(layers[0].values.map(function(d) { return d.date; }))
          .rangeRoundBands([0, width], .1, 0);    
        y.domain([0, yStackMax]);


        var layer = svg1.selectAll(".layer")
          .data(layers)
        .enter().append("g")
          .attr("class", "layer")
          .style("fill", function(d, i) { return z(i); });


        var rect = layer.selectAll("rect")
            .data(function(d) { return d.values; })
            .enter().append("rect")
            .attr("x", function(d) { return x(d.date); })
            .attr("y", height)
            .attr("width", x.rangeBand())
            .attr("height", 0)
            

        rect.transition()
            .delay(function(d, i) { return i * 10; })
            .attr("y", function(d) { return y(d.y0 + d.y); })
          .attr("height", function(d) { return y(d.y0) - y(d.y0 + d.y); });

        svg1.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(xAxis);

        d3.selectAll("#changeInput input").on("change", change);

        var tooltip2 = d3.select("#main2")
          .append("div")
          .attr("class", "remove")
          .style("position", "absolute")
          .style("z-index", "20")
          .style("visibility", "hidden")
          .style("top", "10px")
          .style("left", "120px");

        svg1.append("g")
            .attr("class", "y axis")
            .call(yAxis.orient("left"));

        var timeout = setTimeout(function() {
            d3.select("input[value=\"grouped\"]").property("checked", true).each(change);
          }, 2000);

          function change() {
            clearTimeout(timeout);
            if (this.value === "grouped") transitionGrouped();
            else transitionStacked();
          }

          function transitionGrouped() {
            y.domain([0, yGroupMax]);

            rect.transition()
                .duration(500)
                .delay(function(d, i) { return i * 10; })
                .attr("x", function(d, i, j) { return x(d.date) + x.rangeBand()/layers.length * j; })
                .attr("width", x.rangeBand()/layers.length)
              .transition()
                .attr("y", function(d) { return y(d.y); })
                .attr("height", function(d) { return height - y(d.y); });
          }

          function transitionStacked() {
              
            y.domain([0, yStackMax]);

            rect.transition()
                .duration(500)
                .delay(function(d, i) { return i * 10; })
                .attr("y", function(d) { return y(d.y0 + d.y); })
                .attr("height", function(d) { return y(d.y0) - y(d.y0 + d.y); })
              .transition()
                .attr("x", function(d) { return x(d.date); })
                .attr("width",  x.rangeBand() - 1);
          }


        svg1.selectAll(".layer")
          .attr("opacity", 1)
          .on("mouseover", function(d, i) {
            svg1.selectAll(".layer").transition()
            .duration(250)
            .attr("opacity", function(d, j) {
              return j != i ? 0.6 : 1;
          })})

          .on("mousemove", function(d, i) {
            mousex = d3.mouse(this)[0];
            var leftEdges = x.range();
             var width = x.rangeBand();
             var j;
             for(j=0; mousex > (leftEdges[j] + width); j++) {}
                 //do nothing, just increment j until case fails
            var invertedx = x.domain()[j];
            invertedx = invertedx.getMonth() + invertedx.getDate();
            var selected = (d.values);
            for (var k = 0; k < selected.length; k++) {
              datearray[k] = selected[k].date
              datearray[k] = datearray[k].getMonth() + datearray[k].getDate();
            }

            mousedate = datearray.indexOf(invertedx);
            pro = d.values[mousedate].value;
            eventData = d.values[mousedate].event;

            d3.select(this)
            .classed("hover", true)
            .attr("stroke", strokecolor)
            .attr("stroke-width", "0.5px"), 
            tooltip2.html( "<p>" + d.key + "<br>" + pro + "<br>" + d.values[mousedate].dateStr + "<br>" + eventData +"</p>" ).style("visibility", "visible");
            
          })
          .on("mouseout", function(d, i) {
           svg1.selectAll(".layer")
            .transition()
            .duration(250)
            .attr("opacity", "1");
            d3.select(this)
            .classed("hover", false)
            .attr("stroke-width", "0px"), tooltip2.html( "<p>" + d.key + "<br>" + pro + "<br>" + d.values[mousedate].dateStr + "<br>" + eventData +"</p>" ).style("visibility", "hidden");
        })
          
        var vertical = d3.select("#main2")
              .append("div")
              .attr("class", "remove")
              .style("position", "absolute")
              .style("z-index", "19")
              .style("width", "1px")
              .style("height", "380px")
              .style("top", "10px")
              .style("bottom", "30px")
              .style("left", "0px")
              .style("background", "#fff");

        d3.select("#main2")
            .on("mousemove", function(){  
               mousex = d3.mouse(this);
               mousex = mousex[0];
               vertical.style("left", mousex + "px" )})
            .on("mouseover", function(){  
               mousex = d3.mouse(this);
               mousex = mousex[0];
               vertical.style("left", mousex + "px")});

            renderLegend(colorrange, layers, svg1);
  });
}

</script>

</body>
</html>